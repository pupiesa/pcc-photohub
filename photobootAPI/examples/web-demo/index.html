<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PhotoboothAPI ‚Äî Web Demo</title>
  <style>
    :root { --bg:#0b1020; --card:#121a33; --ink:#e8eefc; --muted:#a9b4d6; --acc:#6aa7ff; --ok:#3ad29f; --err:#ff6b6b; }
    html,body{height:100%}
    body{margin:0; background:linear-gradient(180deg,#0b1020,#0e1430 40%,#0b1020); color:var(--ink); font:15px/1.4 system-ui,Segoe UI,Roboto,Arial;}
    .wrap{max-width:1100px; margin:24px auto; padding:0 16px}
    h1{font-size:22px; letter-spacing:.3px;}
    .grid{display:grid; grid-template-columns:1fr; gap:14px}
    @media(min-width:980px){ .grid{grid-template-columns:1fr 1fr} }
    .card{background:var(--card); border:1px solid #1b2550; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.35); padding:16px}
    .title{display:flex; align-items:center; gap:8px; font-weight:700; margin-bottom:10px}
    .row{display:grid; grid-template-columns:170px 1fr; gap:10px; align-items:center; margin:6px 0}
    label{color:var(--muted)}
    input,select,textarea{background:#0e1530; color:var(--ink); border:1px solid #253066; border-radius:10px; outline:none; padding:10px 12px}
    textarea{min-height:84px}
    input:focus,textarea:focus{border-color:#3b57c7; box-shadow:0 0 0 3px rgba(106,167,255,.2)}
    .btns{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
    button{background:#17306b; color:#eef3ff; border:1px solid #2b4aa1; border-radius:12px; padding:10px 14px; cursor:pointer}
    button:hover{filter:brightness(1.1)}
    button.ok{background:#0f5d4d; border-color:#12836b}
    button.warn{background:#6b2f17; border-color:#b05a2d}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    pre{background:#091028; color:#dce7ff; border:1px solid #1b2550; border-radius:12px; padding:14px; max-height:360px; overflow:auto}
    small{color:var(--muted)}
    .footer{opacity:.8; margin-top:14px}
    .thumbs{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:8px}
    .thumb{border:1px solid #283166; border-radius:10px; overflow:hidden; background:#0e1530}
    .thumb img{width:100%; height:120px; object-fit:cover; display:block}
    .badge{display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; background:#1c2c64; border:1px solid #2d4499; color:#d8e4ff}
    .muted{color:#9fb0db}
  </style>
</head>
<body>
<div class="wrap">
  <h1>üì∏ PhotoboothAPI ‚Äî Web Demo</h1>

  <!-- CONFIG -->
  <div class="card">
    <div class="title">üîß ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API</div>
    <div class="row"><label>Mongo API URL</label><input id="cfg_mongo" value="http://localhost:2000"/></div>
    <div class="row"><label>Nextcloud API URL</label><input id="cfg_nc" value="http://localhost:1000"/></div>
    <div class="btns">
      <button id="btnSaveCfg">Save</button>
      <button id="btnPing" class="ok">Ping APIs</button>
      <small>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ô browser</small>
    </div>
  </div>

  <div class="grid" style="margin-top:14px">
    <!-- USER -->
    <div class="card">
      <div class="title">1) User</div>
      <div class="row"><label>Number (phone)</label><input id="u_number" placeholder="0912345678"/></div>
      <div class="row"><label>PIN (optional)</label><input id="u_pin" placeholder="123456"/></div>
      <div class="btns">
        <button id="btnEnsureUser" class="ok">Ensure User (create if missing)</button>
        <button id="btnGetUser">Get User</button>
        <button id="btnCreateUser">Create User</button>
        <button id="btnChangePin">Change PIN</button>
      </div>
      <div class="btns" style="margin-top:6px">
        <button id="btnSyncPinCloud">Change PIN & Sync Cloud Password</button>
        <small class="muted">‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö PIN ‡∏î‡πâ‡∏ß‡∏¢</small>
      </div>
    </div>

    <!-- UPLOAD -->
    <div class="card">
      <div class="title">2) Upload ‡∏£‡∏π‡∏õ</div>

      <!-- A) Upload ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå ‡∏î‡πâ‡∏ß‡∏¢ file picker (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ endpoint /upload-bytes ‡∏ó‡∏µ‡πà nextcloud-api) -->
      <div class="row"><label>Folder Name</label><input id="up_folder" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏ä‡πâ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå"/></div>
      <div class="row"><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå (‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)</label><input id="up_files" type="file" multiple /></div>
      <div class="row"><label>Note</label><input id="up_note" value="ProjectPhoto_PCC"/></div>
      <div class="row"><label>Link Password</label><input id="up_pass" placeholder="‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ"/></div>
      <div class="row"><label>Expire (YYYY-MM-DD)</label><input id="up_exp" placeholder="2026-12-31"/></div>
      <div class="btns">
        <button id="btnUploadBytesOnly">Upload (bytes) Only</button>
      </div>

      <hr style="opacity:.2;margin:14px 0">

      <!-- B) ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏î‡∏¥‡∏°: ‡∏™‡πà‡∏á‡∏û‡∏≤‡∏ò‡πÑ‡∏ü‡∏•‡πå‡∏ö‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå -->
      <div class="row"><label>Server File Paths</label>
        <textarea id="up_server_paths" placeholder="C:\images\a.jpg
D:\cam\shot1.png
/home/user/pic.jpg"></textarea>
      </div>
      <div class="btns">
        <button id="btnFlowUpload" class="ok">Flow Upload (server paths)</button>
        <button id="btnUploadShare">Upload+Share (first path)</button>
        <button id="btnUploadOnly">Upload Only (all paths)</button>
        <small>‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡∏ù‡∏±‡πà‡∏á <b>‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</b> ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ô nextcloud-api</small>
      </div>
    </div>

    <!-- GALLERY -->
    <div class="card">
      <div class="title">3) Gallery</div>
      <div class="row"><label>Number (phone)</label><input id="gal_number" placeholder="0912345678"/></div>
      <div class="btns">
        <button id="btnLoadGallery" class="ok">Load Gallery</button>
      </div>
      <div id="galleryInfo" class="muted" style="margin:8px 0 6px"></div>
      <div id="thumbs" class="thumbs"></div>
      <small>Preview ‡πÉ‡∏ä‡πâ <code>/api/nextcloud/preview?path=‚Ä¶</code> ‡∏à‡∏≤‡∏Å nextcloud-api</small>
    </div>

    <!-- PROMO -->
    <div class="card">
      <div class="title">4) Promo</div>
      <div class="row"><label>Code</label><input id="pm_code" value="WELCOME10"/></div>
      <div class="row"><label>Type</label>
        <select id="pm_type">
          <option value="percent">percent</option>
          <option value="fixed">fixed</option>
        </select>
      </div>
      <div class="row"><label>Value</label><input id="pm_value" type="number" value="10"/></div>
      <div class="row"><label>Order Amount</label><input id="pm_amt" type="number" value="500"/></div>
      <div class="btns">
        <button id="btnPromoCreate">Create</button>
        <button id="btnPromoValidate" class="ok">Validate</button>
        <button id="btnPromoRedeem">Redeem</button>
        <button id="btnPromoList">List active</button>
      </div>
    </div>

    <!-- CLOUD LINK PASSWORD -->
    <div class="card">
      <div class="title">5) Cloud Link Password</div>
      <div class="row"><label>Folder Name</label><input id="cp_folder" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£"/></div>
      <div class="row"><label>New Password</label><input id="cp_newpass" placeholder="‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á = ‡∏•‡∏ö‡∏£‡∏´‡∏±‡∏™"/></div>
      <div class="row"><label>Expire (YYYY-MM-DD)</label><input id="cp_exp" placeholder="‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á = ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ / ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á = ‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏"/></div>
      <div class="row"><label>Note</label><input id="cp_note" placeholder=""/></div>
      <div class="row"><label>Public Upload?</label>
        <select id="cp_pub">
          <option value="">(‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞)</option>
          <option value="true">true</option>
          <option value="false">false</option>
        </select>
      </div>
      <div class="row"><label>Permissions</label>
        <input id="cp_perm" placeholder="‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á = ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ (‡∏Ñ‡πà‡∏≤ OCS)"/>
      </div>
      <div class="btns">
        <button id="btnChangeSharePass" class="ok">Apply</button>
        <small>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏´‡∏±‡∏™/‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏/‡πÇ‡∏ô‡πâ‡∏ï/‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞ ‡∏Ç‡∏≠‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ä‡∏£‡πå</small>
      </div>
    </div>

    <!-- LOG -->
    <div class="card">
      <div class="title">üìú Log</div>
      <pre id="log" class="mono">Ready.</pre>
      <div class="btns"><button id="btnClearLog" class="warn">Clear Log</button></div>
      <div class="footer"><small>Tip: ‡∏ñ‡πâ‡∏≤ CORS error ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î CORS ‡πÉ‡∏ô mongo-api / nextcloud-api (‡∏Ñ‡πà‡∏≤ allowNoOrigin ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô true ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ)</small></div>
    </div>
  </div>
</div>

<script type="module">
  // ======= SDK (inline) ‚Äî no auth flow =======
  class PhotoboothClient {
    constructor({ mongoBase, ncBase }) { this.mongo = mongoBase.replace(/\/$/,''); this.nc = ncBase.replace(/\/$/,''); }

    // USER
    getUserByNumber(n){ return this._get(`${this.mongo}/api/user/by-number/${encodeURIComponent(n)}`) }
    createUser(b){ return this._post(`${this.mongo}/api/user`, b) }
    setNextcloudLink(n,link){ return this._patch(`${this.mongo}/api/user/${encodeURIComponent(n)}/nextcloud-link`,{nextcloud_link:link}) }
    appendFileAddress(n,f){ return this._post(`${this.mongo}/api/user/${encodeURIComponent(n)}/file-address`,{file_address:f}) }
    changePin(n,p){ return this._patch(`${this.mongo}/api/user/${encodeURIComponent(n)}/pin`,{pin:p}) }
    async ensureUser({number,pin}) {
      try { return await this.getUserByNumber(number); }
      catch(e){ if(e.status!==404) throw e; await this.createUser({number,pin}); return await this.getUserByNumber(number); }
    }

    // PROMO
    listPromos({active}={}){ const q=active?"?active=true":""; return this._get(`${this.mongo}/api/promos${q}`) }
    createPromo(b){ return this._post(`${this.mongo}/api/promos`,b) }
    getPromo(c){ return this._get(`${this.mongo}/api/promos/${encodeURIComponent(c)}`) }
    updatePromo(c,b){ return this._patch(`${this.mongo}/api/promos/${encodeURIComponent(c)}`,b) }
    deactivatePromo(c){ return this._post(`${this.mongo}/api/promos/${encodeURIComponent(c)}/deactivate`) }
    validatePromo(c,b){ return this._post(`${this.mongo}/api/promos/${encodeURIComponent(c)}/validate`,b) }
    redeemPromo(c,b){ return this._post(`${this.mongo}/api/promos/${encodeURIComponent(c)}/redeem`,b) }

    // NEXTCLOUD
    uploadAndShare(b){ return this._post(`${this.nc}/api/nextcloud/upload-and-share`, b) }
    uploadOnly(b){ return this._post(`${this.nc}/api/nextcloud/upload`, b) }
    // (‡πÉ‡∏´‡∏°‡πà) ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ö‡∏ï‡πå (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ endpoint ‡πÉ‡∏ô nextcloud-api)
    async uploadBytes({ folderName, file, targetName, share=false, note, linkPassword, expiration, forceNew }) {
      const ep = share ? '/api/nextcloud/upload-bytes-share' : '/api/nextcloud/upload-bytes';
      const url = `${this.nc}${ep}`;
      const fd = new FormData();
      fd.append('folderName', folderName);
      fd.append('file', file, targetName || file.name);
      if (targetName) fd.append('targetName', targetName);
      if (share) {
        if (note) fd.append('note', note);
        if (linkPassword) fd.append('linkPassword', linkPassword);
        if (expiration) fd.append('expiration', expiration);
        if (forceNew) fd.append('forceNew', 'true');
      }
      const r = await fetch(url, { method:'POST', body: fd });
      return this._handle(r);
    }

    // GALLERY
    getUserGallery(number){ return this._get(`${this.mongo}/api/user/${encodeURIComponent(number)}/gallery`) }

    // CHANGE SHARE PASSWORD
    changeSharePassword({ folderName, newPassword, expiration, note, publicUpload, permissions }) {
      return this._post(`${this.nc}/api/nextcloud/change-share-password`, { folderName, newPassword, expiration, note, publicUpload, permissions });
    }
    changeSharePasswordForUser({ number, newPassword, expiration, note, publicUpload, permissions }) {
      return this.changeSharePassword({ folderName:number, newPassword, expiration, note, publicUpload, permissions });
    }

    // ORCHESTRATION: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô PIN ‡πÅ‡∏•‡πâ‡∏ß sync cloud password
    async changePinAndSyncCloud({ number, newPin, expiration, note, publicUpload, permissions, throwOnCloudFail=false }) {
      await this.changePin(number, newPin);
      try{
        const cloudRes = await this.changeSharePasswordForUser({ number, newPassword:newPin, expiration, note, publicUpload, permissions });
        return { ok:true, cloud: cloudRes };
      }catch(e){
        if (throwOnCloudFail) { const err=new Error(`PIN updated, but cloud password update failed: ${e?.message||'CLOUD_SYNC_FAILED'}`); err.status=e?.status||e?.payload?.status||500; err.cause=e; throw err; }
        return { ok:true, cloud:null, warning:{ message:'PIN updated, but failed to update cloud link password.', error:e?.message||String(e) } };
      }
    }

    // helpers
    async _get(u){const r=await fetch(u); return this._handle(r)}
    async _post(u,b){const r=await fetch(u,{method:'POST',headers:{},body: (b && !(b instanceof FormData)) ? JSON.stringify(b) : (b||null), ...(b && !(b instanceof FormData) ? {headers:{'Content-Type':'application/json'}}:{} )}); return this._handle(r)}
    async _patch(u,b){const r=await fetch(u,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)}); return this._handle(r)}
    async _handle(r){ let data=null; try{data=await r.json()}catch{data={}} if(!r.ok || data?.ok===false){const e=new Error(data?.message||data?.error||`HTTP_${r.status}`); e.status=r.status; e.payload=data; throw e} return data }
  }

  // ===== Utilities =====
  const $ = (s)=>document.querySelector(s);
  const logEl = $('#log');
  function log(title, data){ const t=(typeof data==='string')?data:JSON.stringify(data,null,2); logEl.textContent += `\n\n‚Ä∫ ${title}\n`+t; logEl.scrollTop=logEl.scrollHeight; }
  function clearLog(){ logEl.textContent='Ready.'; }
  function getCfg(){ return JSON.parse(localStorage.getItem('pb_cfg')||'{}'); }
  function saveCfg(v){ localStorage.setItem('pb_cfg', JSON.stringify(v)); }
  function api(){ const {mongoBase,ncBase}=getCfg(); return new PhotoboothClient({ mongoBase, ncBase }); }
  function splitPaths(s){ const a=(s||'').trim(); if(!a) return []; return a.split(/[,|\r?\n]+/).map(t=>t.trim()).filter(Boolean); }

  // derive preview url from relative path (for /api/nextcloud/preview)
  function buildPreview(rel){ const {ncBase}=getCfg(); return `${ncBase.replace(/\/$/,'')}/api/nextcloud/preview?path=${encodeURIComponent(rel)}`; }
  function deriveRelFromItem(it){
    if (it?.path) return String(it.path).replace(/^\/+/,'');
    if (it?.name) return String(it.name).replace(/^\/+/,'');
    try{
      if (it?.previewUrl){ const u=new URL(it.previewUrl); const f=u.searchParams.get('file'); if (f) return decodeURIComponent(f).replace(/^\/+/,''); }
    }catch{}
    try{
      if (it?.downloadUrl){ const u=new URL(it.downloadUrl); const dir=u.searchParams.get('path'); const files=u.searchParams.get('files'); if(files){ const d=dir?decodeURIComponent(dir).replace(/^\/+/,''):''; return d?`${d}/${files}`:files; } }
    }catch{}
    return '';
  }
  function toCloudPath(resp){
    const up = resp?.uploaded || resp || {};
    const remote = up.remotePath || up.remote || '';
    const folder = up.folder || up.folderPath || '';
    const file   = up.file || up.fileName || '';
    if (remote){ if (file && !remote.endsWith(file)) return `${remote.replace(/\/$/,'')}/${file}`; return remote; }
    if (folder && file) return `${String(folder).replace(/\/$/,'')}/${file}`;
    return file || folder || null;
  }

  // ===== Init UI =====
  const cfgSaved = getCfg();
  if (cfgSaved.mongoBase) $('#cfg_mongo').value = cfgSaved.mongoBase;
  if (cfgSaved.ncBase)    $('#cfg_nc').value    = cfgSaved.ncBase;

  // Save & Ping
  $('#btnSaveCfg').onclick = ()=>{ saveCfg({ mongoBase:$('#cfg_mongo').value.trim(), ncBase:$('#cfg_nc').value.trim() }); log('Saved config', getCfg()); };
  $('#btnPing').onclick = async ()=>{
    const {mongoBase,ncBase} = getCfg();
    try{ const m = await fetch(`${mongoBase.replace(/\/$/,'')}/health`, {cache:'no-store'}).then(r=>r.json()); log('Ping Mongo', m); }catch(e){ log('Ping Mongo error', String(e)); }
    try{ const n = await fetch(`${ncBase.replace(/\/$/,'')}/api/health`, {cache:'no-store'}).then(r=>r.json()); log('Ping Nextcloud', n); }catch(e){ log('Ping Nextcloud error', String(e)); }
  };

  // ===== User =====
  $('#btnEnsureUser').onclick = async ()=>{
    const number=$('#u_number').value.trim(); const pin=$('#u_pin').value.trim();
    const cli=api();
    try{ const r=await cli.ensureUser({number,pin}); log('EnsureUser', r); $('#up_folder').value = number; $('#gal_number').value = number; }
    catch(e){ log('EnsureUser error', {status:e.status, message:e.message, payload:e.payload}); }
  };
  $('#btnGetUser').onclick = async ()=>{
    const number=$('#u_number').value.trim(); const cli=api();
    try{ const r=await cli.getUserByNumber(number); log('GetUser', r); }
    catch(e){ log('GetUser error', {status:e.status, message:e.message}); }
  };
  $('#btnCreateUser').onclick = async ()=>{
    const number=$('#u_number').value.trim(); const pin=$('#u_pin').value.trim(); const cli=api();
    try{ const r=await cli.createUser({number,pin}); log('CreateUser', r); }
    catch(e){ log('CreateUser error', {status:e.status, message:e.message, payload:e.payload}); }
  };
  $('#btnChangePin').onclick = async ()=>{
    const number=$('#u_number').value.trim(); const pin=$('#u_pin').value.trim(); const cli=api();
    try{ const r=await cli.changePin(number, pin); log('ChangePin', r); }
    catch(e){ log('ChangePin error', {status:e.status, message:e.message, payload:e.payload}); }
  };
  $('#btnSyncPinCloud').onclick = async ()=>{
    const number=$('#u_number').value.trim(); const newPin=$('#u_pin').value.trim(); const cli=api();
    try{ const r=await cli.changePinAndSyncCloud({ number, newPin }); log('ChangePinAndSyncCloud', r); }
    catch(e){ log('ChangePinAndSyncCloud error', {status:e.status, message:e.message, payload:e.payload}); }
  };

  // ===== Upload (bytes) =====
  async function uploadBytesMany({ share }){
    const files = $('#up_files').files;
    const number = $('#u_number').value.trim();
    const folder = $('#up_folder').value.trim() || number;
    if (!files || files.length===0) { log('UploadBytes', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå'); return; }
    const cli=api();
    const note=$('#up_note').value; const linkPassword=$('#up_pass').value; const expiration=$('#up_exp').value || undefined;

    try{
      const remotes=[];
      for (let i=0;i<files.length;i++){
        const f = files[i];
        const res = await cli.uploadBytes({
          folderName: folder,
          file: f,
          targetName: f.name,
          share: share && i===0, // ‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏£‡∏Å
          note, linkPassword, expiration, forceNew:false
        });
        log(share && i===0 ? 'UploadBytes+Share' : 'UploadBytes', res);
        const remote = toCloudPath(res);
        if (remote) remotes.push(remote);

        // ‡∏ñ‡πâ‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å -> patch ‡∏•‡∏á user
        if (share && i===0 && res?.share?.url) {
          await cli.setNextcloudLink(number, res.share.url);
          log('Patched nextcloud_link', { number, link: res.share.url });
        }
      }
      if (remotes.length){
        await cli.appendFileAddress(number, remotes);
        log('Append file_address', { number, files: remotes });
      }
    }catch(e){
      log('UploadBytes error', {status:e.status, message:e.message, payload:e.payload});
    }
  }
  $('#btnUploadBytesShare').onclick = ()=>uploadBytesMany({ share:true });
  $('#btnUploadBytesOnly').onclick  = ()=>uploadBytesMany({ share:false });

  // ===== Upload (server paths ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏î‡∏¥‡∏°) =====
  $('#btnFlowUpload').onclick = async ()=>{
    const cli=api(); const number=$('#u_number').value.trim();
    const folder=$('#up_folder').value.trim() || number;
    const paths = splitPaths($('#up_server_paths').value);
    const note=$('#up_note').value; const linkPassword=$('#up_pass').value; const expiration=$('#up_exp').value || undefined;
    try{
      if (paths.length===0) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÑ‡∏ü‡∏•‡πå');
      // ensure user ‡∏Å‡πà‡∏≠‡∏ô
      await cli.ensureUser({ number, pin: $('#u_pin').value.trim() });

      const user = (await cli.getUserByNumber(number)).data;
      const remotes=[];
      if (!user.nextcloud_link){
        const up1 = await cli.uploadAndShare({ folderName:folder, filePath: paths[0], note, linkPassword, expiration });
        log('Upload+Share (first)', up1);
        if (up1?.share?.url) await cli.setNextcloudLink(number, up1.share.url);
        const rp1 = toCloudPath(up1); if (rp1) remotes.push(rp1);
        for (const fp of paths.slice(1)){
          const r = await cli.uploadOnly({ folderName:folder, filePath: fp });
          log('UploadOnly', r);
          const rp = toCloudPath(r); if (rp) remotes.push(rp);
        }
      } else {
        for (const fp of paths){
          const r = await cli.uploadOnly({ folderName:folder, filePath: fp });
          log('UploadOnly', r);
          const rp = toCloudPath(r); if (rp) remotes.push(rp);
        }
      }
      if (remotes.length){
        await cli.appendFileAddress(number, remotes);
        log('Append file_address', { number, files: remotes });
      }
    }catch(e){ log('FlowUpload error', {status:e.status, message:e.message, payload:e.payload}); }
  };

  $('#btnUploadShare').onclick = async ()=>{
    const cli=api(); const number=$('#u_number').value.trim();
    const folder=$('#up_folder').value.trim() || number;
    const first = splitPaths($('#up_server_paths').value)[0];
    const note=$('#up_note').value; const linkPassword=$('#up_pass').value; const expiration=$('#up_exp').value || undefined;
    try{
      if(!first) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÑ‡∏ü‡∏•‡πå (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å)');
      const r = await cli.uploadAndShare({ folderName:folder, filePath:first, note, linkPassword, expiration });
      log('Upload+Share', r);
      if (r?.share?.url){ await cli.setNextcloudLink(number, r.share.url); log('Patched nextcloud_link', {number, link:r.share.url}); }
      const remote = toCloudPath(r); if (remote) { await cli.appendFileAddress(number, [remote]); log('Append file_address', {number, files:[remote]}); }
    }catch(e){ log('Upload+Share error', {status:e.status, message:e.message, payload:e.payload}); }
  };

  $('#btnUploadOnly').onclick = async ()=>{
    const cli=api(); const number=$('#u_number').value.trim(); const folder=$('#up_folder').value.trim()||number;
    const paths = splitPaths($('#up_server_paths').value);
    try{
      if (paths.length===0) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÑ‡∏ü‡∏•‡πå');
      const remotes=[];
      for (const fp of paths){
        const r = await cli.uploadOnly({ folderName:folder, filePath: fp });
        log('UploadOnly', r);
        const rp = toCloudPath(r); if (rp) remotes.push(rp);
      }
      if (remotes.length){ await cli.appendFileAddress(number, remotes); log('Append file_address', {number, files: remotes}); }
    }catch(e){ log('UploadOnly error', {status:e.status, message:e.message, payload:e.payload}); }
  };

  // ===== Gallery =====
  $('#btnLoadGallery').onclick = async ()=>{
    const number = $('#gal_number').value.trim() || $('#u_number').value.trim();
    const cli=api(); const info=$('#galleryInfo'); const cont=$('#thumbs');
    cont.innerHTML=''; info.textContent='Loading‚Ä¶';
    try{
      const u = await cli.getUserByNumber(number);
      const link = u?.data?.nextcloud_link || null;
      const cnt  = u?.file_summary?.count ?? (Array.isArray(u?.data?.file_address)?u.data.file_address.length:0);
      info.innerHTML = `Total <b>${cnt}</b>${link ? ` ‚Ä¢ <span class="badge">link ready</span>`:''}`;
      const g = await cli.getUserGallery(number);
      const files = (g?.files||[]).filter(it=>{
        const n = (it?.name||'').toLowerCase();
        return /\.(jpe?g|png|webp|gif|bmp|avif)$/.test(n);
      });
      if (files.length===0){ cont.innerHTML='<div class="muted">No photos.</div>'; return; }
      cont.innerHTML = files.map(it=>{
        const rel = deriveRelFromItem(it);
        const src = buildPreview(rel);
        return `<div class="thumb"><img src="${src}" alt=""></div>`;
      }).join('');
    }catch(e){
      info.textContent='Load failed.'; log('LoadGallery error', {status:e.status, message:e.message, payload:e.payload});
    }
  };

  // ===== Promo =====
  $('#btnPromoCreate').onclick = async ()=>{
    const cli=api(); const code=$('#pm_code').value.trim(); const type=$('#pm_type').value; const value=Number($('#pm_value').value||0);
    try{
      const now=new Date(); const end=new Date(Date.now()+86400000*30);
      const body={ code, type, value, start_at: now, end_at: end, usage_limit:1000, per_user_limit:1, is_active:true };
      const r=await cli.createPromo(body); log('Promo created', r);
    }catch(e){ log('Promo create error', {status:e.status, message:e.message, payload:e.payload}); }
  };
  $('#btnPromoValidate').onclick = async ()=>{
    const cli=api(); const code=$('#pm_code').value.trim(); const number=$('#u_number').value.trim(); const amt=Number($('#pm_amt').value||0);
    try{ const r=await cli.validatePromo(code,{userNumber:number, orderAmount:amt}); log('Promo validate', r); }
    catch(e){ log('Promo validate error', {status:e.status, message:e.message, payload:e.payload}); }
  };
  $('#btnPromoRedeem').onclick = async ()=>{
    const cli=api(); const code=$('#pm_code').value.trim(); const number=$('#u_number').value.trim(); const amt=Number($('#pm_amt').value||0);
    try{ const r=await cli.redeemPromo(code,{userNumber:number, orderAmount:amt}); log('Promo redeem', r); }
    catch(e){ log('Promo redeem error', {status:e.status, message:e.message, payload:e.payload}); }
  };
  $('#btnPromoList').onclick = async ()=>{
    const cli=api();
    try{ const r=await cli.listPromos({active:true}); log('Promo list (active)', r); }
    catch(e){ log('Promo list error', {status:e.status, message:e.message}); }
  };

  // ===== Cloud Link Password =====
  $('#btnChangeSharePass').onclick = async ()=>{
    const folderName=$('#cp_folder').value.trim();
    const newPassword=$('#cp_newpass').value; // ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á = ‡∏•‡∏ö‡∏£‡∏´‡∏±‡∏™
    const expiration=$('#cp_exp').value;      // "" = ‡∏•‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏, undefined = ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞
    const note=$('#cp_note').value;
    const pubSel=$('#cp_pub').value;
    const publicUpload = pubSel==='' ? undefined : (pubSel==='true');
    const permRaw=$('#cp_perm').value.trim();
    const permissions = permRaw==='' ? undefined : Number(permRaw);
    const cli=api();
    try{
      const r = await cli.changeSharePassword({ folderName, newPassword, expiration, note, publicUpload, permissions });
      log('ChangeSharePassword', r);
    }catch(e){ log('ChangeSharePassword error', {status:e.status, message:e.message, payload:e.payload}); }
  };

  // Log clear
  $('#btnClearLog').onclick = clearLog;
</script>
</body>
</html>
